name: FINAL MacWhisper Pro

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Audio URL to transcribe with MacWhisper Pro'
        required: true
        type: string

jobs:
  final-macwhisper-pro:
    runs-on: [self-hosted, macmini]
    timeout-minutes: 30

    steps:
      - name: Final MacWhisper Pro Transcription
        run: |
          echo "=== FINAL MACWHISPER PRO TRANSCRIPTION ==="
          echo "ğŸ¯ This bypasses all caching issues"
          echo "ğŸ“± URL: ${{ inputs.url }}"
          echo ""

          # Load environment
          if [[ -f "$HOME/.config/relayq/env" ]]; then
            source "$HOME/.config/relayq/env"
            echo "âœ“ Environment loaded"
          fi

          # Create working directory
          mkdir -p /tmp/final-transcription
          cd /tmp/final-transcription

          # Download audio
          echo "ğŸ“¥ Downloading audio..."
          yt-dlp -f "bestaudio" -o "audio.mp3" --no-playlist "${{ inputs.url }}"

          if [[ -f "audio.mp3" ]]; then
            echo "âœ… Audio downloaded: $(ls -lh audio.mp3)"
            echo ""

            # DIRECT MacWhisper Pro transcription - no scripts involved
            echo "ğŸš€ Starting DIRECT MacWhisper Pro transcription..."
            echo "ğŸ¯ Using large-v3 model for best quality"
            echo "âš¡ Using Metal acceleration"
            echo ""

            python3 -c "
import whisper
import sys

try:
    print('ğŸš€ Loading MacWhisper Pro LARGE-V3 model...')
    model = whisper.load_model('large-v3', device='mps')
    print('âš¡ Transcribing with MacWhisper Pro quality...')
    print('')

    result = model.transcribe('audio.mp3',
                             language=None,  # Auto-detect
                             verbose=False)

    transcript = result['text']
    print('')
    print('âœ… SUCCESS! MacWhisper Pro transcription completed!')
    print(f'ğŸ“Š Length: {len(transcript)} characters')
    print(f'ğŸŒ Language: {result.get(\"language\", \"auto-detected\")}')
    print('')

    # Save transcript
    with open('final-transcript.txt', 'w') as f:
        f.write(transcript)

    print('ğŸ’¾ Professional transcript saved!')
    print(f'ğŸ“ File: final-transcript.txt')
    print('')

except Exception as e:
    print(f'âŒ MacWhisper Pro transcription failed: {e}')
    import traceback
    traceback.print_exc()
    sys.exit(1)
"

            if [[ -f "final-transcript.txt" && -s "final-transcript.txt" ]]; then
              echo ""
              echo "ğŸ‰ === FINAL MACWHISPER PRO TRANSCRIPT ==="
              echo ""
              cat final-transcript.txt
              echo ""
              echo "=== END PROFESSIONAL TRANSCRIPT ==="
              echo ""
              echo "âœ¨ SUCCESS! MacWhisper Pro transcription completed!"
              echo "ğŸ“ˆ Total characters: $(wc -c < final-transcript.txt)"
              echo "ğŸ¯ Quality: Professional grade with large-v3 model"
              echo "âš¡ Acceleration: Metal Performance Shaders (MPS)"
              echo ""
            else
              echo "âŒ No transcript generated"
              exit 1
            fi
          else
            echo "âŒ Failed to download audio"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -rf /tmp/final-transcription