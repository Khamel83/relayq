name: Push Transcription

on:
  push:
    branches: [ master ]

jobs:
  check-and-transcribe:
    runs-on: [self-hosted, macmini]
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for transcription request
        id: check-and-transcribe
        run: |
          echo "ğŸ” Checking for transcription request..."

          # Look for transcription request file
          if [[ -f "transcription_request.txt" ]]; then
            URL=$(cat transcription_request.txt)
            echo "âœ… Found transcription request: $URL"
            echo "url=$URL" >> $GITHUB_OUTPUT
            rm transcription_request.txt  # Clean up
          else
            echo "â„¹ï¸ No transcription request found"
            echo "To request transcription: echo 'URL' > transcription_request.txt && git push"
            exit 0
          fi

      - name: Transcribe Audio
        if: steps.check-and-transcribe.outputs.url
        run: |
          echo "ğŸš€ STARTING TRANSCRIPTION"
          echo "ğŸ”— URL: ${{ steps.check-and-transcribe.outputs.url }}"
          echo ""

          # Load environment
          if [[ -f "$HOME/.config/relayq/env" ]]; then
            source "$HOME/.config/relayq/env"
            echo "âœ… Environment loaded"
          fi

          # Create directory
          mkdir -p /tmp/push-transcription
          cd /tmp/push-transcription

          # Download with yt-dlp
          echo "ğŸ“¥ Downloading audio..."
          yt-dlp -f "bestaudio" -o "audio.mp3" --no-playlist "${{ steps.check-and-transcribe.outputs.url }}"

          if [[ -f "audio.mp3" ]]; then
            echo "âœ… Audio downloaded: $(ls -lh audio.mp3)"
            echo ""

            # Transcribe with large-v3 model
            echo "ğŸ¤– Transcribing with large-v3 model..."
            python3 -c "
import whisper

try:
    print('Loading large-v3 model...')
    model = whisper.load_model('large-v3', device='mps')
    print('Transcribing...')
    result = model.transcribe('audio.mp3', verbose=False)

    transcript = result['text']

    # Save transcript
    with open('transcript.txt', 'w') as f:
        f.write(transcript)

    print('')
    print('ğŸ‰ SUCCESS!')
    print(f'ğŸ“Š Length: {len(transcript)} characters')
    print(f'ğŸŒ Language: {result.get(\"language\", \"auto-detected\")}')
    print('')
    print('ğŸ“„ FIRST 1000 CHARACTERS:')
    print('=' * 50)
    print(transcript[:1000])
    print('=' * 50)

except Exception as e:
    print(f'âŒ Error: {e}')
    import traceback
    traceback.print_exc()
    exit(1)
"

            # Save results
            cp transcript.txt /tmp/transcript_results.txt
            echo "âœ… Transcription saved to /tmp/transcript_results.txt"

            # Display results
            if [[ -f "transcript.txt" && -s "transcript.txt" ]]; then
              echo ""
              echo "ğŸ‰ === TRANSCRIPT RESULTS ==="
              echo ""
              head -c 1000 transcript.txt
              echo ""
              echo "=== END PREVIEW ==="
              echo ""
              echo "ğŸ“„ Full transcript: $(wc -c < transcript.txt) characters"
            else
              echo "âŒ No transcript file created"
            fi
          else
            echo "âŒ Failed to download audio"
          fi

      - name: Upload Results
        if: steps.check-and-transcribe.outputs.url
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: podcast-transcript
          path: /tmp/transcript_results.txt
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          rm -rf /tmp/push-transcription
          rm -f /tmp/transcript_results.txt