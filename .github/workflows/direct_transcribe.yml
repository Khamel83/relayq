name: Direct Transcription

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Audio URL to transcribe'
        required: true
        type: string

jobs:
  transcribe:
    runs-on: [self-hosted, macmini]
    timeout-minutes: 30

    steps:
      - name: Direct transcription
        run: |
          echo "ğŸš€ DIRECT TRANSCRIPTION"
          echo "ğŸ”— URL: ${{ inputs.url }}"
          echo ""

          # Load environment
          if [[ -f "$HOME/.config/relayq/env" ]]; then
            source "$HOME/.config/relayq/env"
            echo "âœ… Environment loaded"
          fi

          # Create directory
          mkdir -p /tmp/transcription
          cd /tmp/transcription

          # Download with yt-dlp
          echo "ğŸ“¥ Downloading audio..."
          yt-dlp -f "bestaudio" -o "audio.mp3" --no-playlist "${{ inputs.url }}"

          if [[ -f "audio.mp3" ]]; then
            echo "âœ… Audio downloaded: $(ls -lh audio.mp3)"
            echo ""

            # Transcribe with large-v3 model
            echo "ğŸ¤– Transcribing with large-v3 model..."
            python3 -c "
import whisper

try:
    print('Loading large-v3 model...')
    model = whisper.load_model('large-v3', device='mps')
    print('Transcribing...')
    result = model.transcribe('audio.mp3', verbose=False)

    transcript = result['text']

    # Save transcript
    with open('transcript.txt', 'w') as f:
        f.write(transcript)

    print('')
    print('ğŸ‰ SUCCESS!')
    print(f'ğŸ“Š Length: {len(transcript)} characters')
    print(f'ğŸŒ Language: {result.get(\"language\", \"auto-detected\")}')
    print('')
    print('ğŸ“„ FIRST 1000 CHARACTERS:')
    print('=' * 50)
    print(transcript[:1000])
    print('=' * 50)

except Exception as e:
    print(f'âŒ Error: {e}')
    import traceback
    traceback.print_exc()
    exit(1)
"

            # Display results
            if [[ -f "transcript.txt" && -s "transcript.txt" ]]; then
              echo ""
              echo "ğŸ‰ === FULL TRANSCRIPT ==="
              cat transcript.txt
              echo "=== END TRANSCRIPT ==="
            else
              echo "âŒ No transcript file created"
            fi
          else
            echo "âŒ Failed to download audio"
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -rf /tmp/transcription